<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>쿠폰 사용 추이 - Moonlight</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="common.css">
    <style>
        /* Theme: Blue */
        header h1 {
            background: linear-gradient(90deg, #3182ce 0%, #2c5282 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .stat-value { color: #3182ce; }
        .tab-btn {
            border: 2px solid #3182ce;
            color: #3182ce;
        }
        .tab-btn:hover { background: #ebf8ff; }
        .tab-btn.active {
            background: linear-gradient(90deg, #3182ce, #2c5282);
            color: #fff;
            border-color: #3182ce;
        }
        .chart-container {
            background: #1a202c;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        }
        .chart-container h2 {
            color: #e2e8f0;
        }
        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            align-items: center;
        }
        .controls label {
            font-weight: 500;
            color: #a0aec0;
        }
        .controls select, .controls input {
            padding: 8px 12px;
            border: 1px solid #4a5568;
            border-radius: 6px;
            font-size: 14px;
            background: #2d3748;
            color: #e2e8f0;
        }
        .type-toggle {
            display: flex;
            gap: 10px;
        }
        .type-btn {
            padding: 8px 16px;
            border: 2px solid #4299e1;
            background: #2d3748;
            color: #4299e1;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .type-btn.active {
            background: #4299e1;
            color: #fff;
        }
        .type-btn:hover:not(.active) {
            background: #374151;
        }
        #heatmap {
            width: 100%;
            height: 600px;
        }
        .realtime-section {
            background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
            color: #fff;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .realtime-section h3 {
            margin: 0 0 10px 0;
            font-size: 1rem;
            opacity: 0.9;
        }
        .realtime-stats {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        .realtime-stat {
            text-align: center;
        }
        .realtime-stat .value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .realtime-stat .label {
            font-size: 0.85rem;
            opacity: 0.8;
        }
        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #a0aec0;
        }
        .no-data h3 {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Moonlight 쿠폰 사용 추이</h1>
            <p>시간별 쿠폰 사용 현황 히트맵</p>
            <div class="deadline-banner">쿠폰 사용 마감일: 2026년 1월 10일 (<span id="daysLeft"></span>)</div>
            <div class="tab-nav">
                <a href="index.html" class="tab-btn">대학교 단체 쿠폰</a>
                <a href="personal.html" class="tab-btn">개인 쿠폰</a>
                <a href="history.html" class="tab-btn active">사용 추이</a>
            </div>
        </header>

        <div id="content">
            <div class="loading">
                <div class="spinner"></div>
                <p>데이터를 불러오는 중...</p>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;
        let dailyData = {};
        let selectedType = 'all'; // 'all', 'group' or 'personal'
        let selectedUniversity = '__ALL__'; // 기본값: 전체
        let heatmapChart = null;

        // GitHub Raw URL (로컬 개발 시 상대경로 사용)
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const GITHUB_RAW_BASE = 'https://raw.githubusercontent.com/jaeyoung2026/moonlight-university-stats3/refs/heads/main';
        const DATA_BASE = isLocal ? '' : GITHUB_RAW_BASE;

        // 실시간 데이터 로드
        async function loadCurrentData() {
            try {
                const url = `${DATA_BASE}/history/current.json`;
                const response = await fetch(url);
                if (!response.ok) return null;
                return await response.json();
            } catch (e) {
                console.warn('No current data:', e);
                return null;
            }
        }

        // 일별 데이터 로드
        async function loadDailyData(dateStr) {
            if (dailyData[dateStr]) return dailyData[dateStr];

            try {
                const url = `${DATA_BASE}/history/daily/${dateStr}.json`;
                const response = await fetch(url);
                if (!response.ok) return null;
                const data = await response.json();
                dailyData[dateStr] = data;
                return data;
            } catch (e) {
                console.warn(`No daily data for ${dateStr}:`, e);
                return null;
            }
        }

        // 12월 11일부터 1월 10일까지 전체 날짜 목록
        function getAvailableDates() {
            const dates = [];
            const startDate = new Date('2025-12-11');
            const endDate = new Date('2026-01-10');

            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                dates.push(d.toISOString().slice(0, 10));
            }

            return dates;
        }

        // 모든 일별 데이터에서 대학교 목록 추출
        function getUniversitiesFromAllData(allDailyData, type) {
            const unis = new Set();

            for (const data of Object.values(allDailyData)) {
                if (data && data.hours) {
                    for (const hour of data.hours) {
                        // type이 'all'이면 group과 personal 모두에서 추출
                        const types = type === 'all' ? ['group', 'personal'] : [type];
                        for (const t of types) {
                            const typeData = hour[t] || {};
                            Object.keys(typeData).forEach(u => unis.add(u));
                        }
                    }
                }
            }

            return Array.from(unis).sort();
        }

        // 여러 날짜의 데이터 로드
        async function loadAllDailyData() {
            const dates = getAvailableDates();
            const promises = dates.map(d => loadDailyData(d));
            await Promise.all(promises);
            return dailyData;
        }

        // UTC를 KST로 변환하는 헬퍼 함수
        function toKST(date) {
            const kst = new Date(date.getTime() + 9 * 60 * 60 * 1000);
            return kst;
        }

        // KST 기준 날짜 문자열 (YYYY-MM-DD)
        function getKSTDateStr(date) {
            const kst = toKST(date);
            return kst.toISOString().slice(0, 10);
        }

        // KST 기준 시간
        function getKSTHour(date) {
            const kst = toKST(date);
            return kst.getUTCHours();
        }

        // 기준 시점: 2025-12-15 15시까지의 누적값
        const BASELINE = {
            date: '2025-12-16',
            hour: 13,
            value: 151  // 14시부터 데이터 수집 시작, 13시까지의 누적 사용량
        };

        // 기준 시점 이후인지 확인
        function isAfterBaseline(dateStr, hour) {
            if (dateStr > BASELINE.date) return true;
            if (dateStr === BASELINE.date && hour > BASELINE.hour) return true;
            return false;
        }

        // current.json에서 모든 시간대별 실시간 값 계산
        // 각 시간대의 증가분 = 해당 시간 마지막 스냅샷 - 이전 시간 마지막 스냅샷
        // 반환: { 'YYYY-MM-DD_HH': { value, hour, date, ... }, ... }
        // allData: daily 데이터 (이전 시간 누적값 참조용)
        function getAllHourValues(current, allData) {
            if (!current || !current.snapshots || current.snapshots.length === 0) {
                return {};
            }

            const types = selectedType === 'all' ? ['group', 'personal'] : [selectedType];

            // 스냅샷에서 total 계산하는 헬퍼
            function getTotal(snap) {
                let total = 0;
                for (const t of types) {
                    if (snap[t]) {
                        if (selectedUniversity === '__ALL__') {
                            total += Object.values(snap[t]).reduce((sum, v) => sum + (v.used || 0), 0);
                        } else {
                            total += snap[t][selectedUniversity]?.used || 0;
                        }
                    }
                }
                return total;
            }

            // 스냅샷을 시간대별로 그룹화
            const grouped = {};
            current.snapshots.forEach(snap => {
                const snapTime = new Date(snap.time);
                const hour = getKSTHour(snapTime);
                const dateStr = getKSTDateStr(snapTime);
                const key = `${dateStr}_${hour}`;

                if (!grouped[key]) {
                    grouped[key] = { snapshots: [], hour, date: dateStr };
                }
                grouped[key].snapshots.push(snap);
            });

            // 시간대 키를 정렬 (시간순)
            const sortedKeys = Object.keys(grouped).sort((a, b) => {
                const [dateA, hourA] = a.split('_');
                const [dateB, hourB] = b.split('_');
                if (dateA !== dateB) return dateA.localeCompare(dateB);
                return parseInt(hourA) - parseInt(hourB);
            });

            const hourlyData = {};
            let prevTotal = null; // 첫 시간대는 daily 데이터에서 가져옴

            for (const key of sortedKeys) {
                const data = grouped[key];

                // 기준 시점 이후가 아니면 스킵 (하지만 prevTotal은 업데이트)
                const finalSnap = data.snapshots[data.snapshots.length - 1];
                const currentTotal = getTotal(finalSnap);

                if (!isAfterBaseline(data.date, data.hour)) {
                    prevTotal = currentTotal;
                    continue;
                }

                // 첫 시간대면 daily 데이터에서 이전 시간 누적값 가져오기
                if (prevTotal === null) {
                    prevTotal = getPrevHourValue(allData, data.date, data.hour);
                }

                // 해당 시간대의 증가분 = 현재 - 이전
                const increment = currentTotal - prevTotal;

                hourlyData[key] = {
                    value: Math.max(0, increment),
                    hour: data.hour,
                    date: data.date,
                    samples: data.snapshots.length,
                    currentTotal: currentTotal,
                    prevTotal: prevTotal
                };

                prevTotal = currentTotal;
            }

            return hourlyData;
        }

        // daily 데이터에서 특정 시간의 누적값 가져오기
        function getDailyHourValue(allData, dateStr, hour) {
            const data = allData[dateStr];
            if (!data || !data.hours) return null; // 데이터 없음을 구분하기 위해 null 반환

            const hourData = data.hours.find(h => h.hour === hour);
            if (!hourData) return null;

            const types = selectedType === 'all' ? ['group', 'personal'] : [selectedType];
            let value = 0;
            for (const t of types) {
                if (hourData[t]) {
                    if (selectedUniversity === '__ALL__') {
                        value += Object.values(hourData[t]).reduce((sum, v) => sum + (v.avg || 0), 0);
                    } else {
                        value += hourData[t][selectedUniversity]?.avg || 0;
                    }
                }
            }
            return value;
        }

        // 이전 시간의 누적값 가져오기 (베이스라인 적용)
        function getPrevHourValue(allData, dateStr, hour) {
            // 기준 시점 이전이면 베이스라인 반환
            if (dateStr < BASELINE.date || (dateStr === BASELINE.date && hour <= BASELINE.hour)) {
                return selectedUniversity === '__ALL__' ? BASELINE.value : 0;
            }

            // 이전 시간 계산
            let prevDate = dateStr;
            let prevHour = hour - 1;

            if (prevHour < 0) {
                // 전날 23시
                const d = new Date(dateStr);
                d.setDate(d.getDate() - 1);
                prevDate = d.toISOString().slice(0, 10);
                prevHour = 23;
            }

            // 이전 시간이 베이스라인 시점이면 베이스라인 값 반환
            if (prevDate < BASELINE.date || (prevDate === BASELINE.date && prevHour <= BASELINE.hour)) {
                return selectedUniversity === '__ALL__' ? BASELINE.value : 0;
            }

            const prevValue = getDailyHourValue(allData, prevDate, prevHour);
            // 이전 시간 데이터가 없으면 재귀적으로 그 이전 시간 찾기
            if (prevValue === null) {
                return getPrevHourValue(allData, prevDate, prevHour);
            }
            return prevValue;
        }

        // 히트맵 렌더링 (X축: 날짜, Y축: 시간)
        async function renderHeatmap() {
            const allData = await loadAllDailyData();
            const dates = getAvailableDates();
            const hours = Array.from({ length: 24 }, (_, i) => `${23 - i}:00`);

            // 모든 시간대별 실시간 값 (current.json에서, daily 데이터 참조)
            const allHourValues = getAllHourValues(currentData, allData);

            // 대학교 목록 추출
            const universities = getUniversitiesFromAllData(allData, selectedType);

            // 히트맵 데이터 생성 [x: 날짜 인덱스, y: 시간 인덱스, value: 사용량]
            const heatmapData = [];
            let maxValue = 0;

            for (let dateIdx = 0; dateIdx < dates.length; dateIdx++) {
                const dateStr = dates[dateIdx];

                for (let hourIdx = 0; hourIdx < 24; hourIdx++) {
                    let value = 0;
                    const actualHour = 23 - hourIdx; // 0시가 위로 가도록 역순
                    const hourKey = `${dateStr}_${actualHour}`;

                    // current.json에 해당 시간대 데이터가 있으면 사용 (이미 증가분 계산됨)
                    if (allHourValues[hourKey]) {
                        value = allHourValues[hourKey].value;
                    } else {
                        // daily 데이터에서 증가분 계산 (현재 시간 누적 - 이전 시간 누적)
                        const currentValue = getDailyHourValue(allData, dateStr, actualHour);

                        if (currentValue !== null && currentValue > 0) {
                            const prevValue = getPrevHourValue(allData, dateStr, actualHour);
                            value = currentValue - prevValue;

                            // 음수 방지 (데이터 누락 시)
                            if (value < 0) value = 0;
                        }
                    }

                    heatmapData.push([dateIdx, hourIdx, Math.round(value)]);
                    maxValue = Math.max(maxValue, value);
                }
            }

            // 날짜 라벨 (MM-DD 형식)
            const dateLabels = dates.map(d => d.slice(5)); // "2025-12-15" -> "12-15"

            if (heatmapChart) {
                heatmapChart.dispose();
            }

            heatmapChart = echarts.init(document.getElementById('heatmap'));

            const option = {
                tooltip: {
                    position: 'top',
                    backgroundColor: '#2d3748',
                    borderColor: '#4a5568',
                    textStyle: { color: '#e2e8f0' },
                    formatter: function (params) {
                        const date = dates[params.data[0]];
                        const hour = 23 - params.data[1]; // 역순 보정
                        const value = params.data[2];
                        const label = selectedUniversity === '__ALL__' ? '전체' : selectedUniversity;
                        // current.json의 실시간 데이터인지 확인
                        const hourKey = `${date}_${hour}`;
                        const isLive = allHourValues[hourKey] !== undefined;
                        const liveTag = isLive ? '<span style="color:#48bb78;">(실시간)</span> ' : '';
                        return `<strong>${label}</strong><br/>${date} ${hour}:00 ${liveTag}<br/>증가: +${value}개`;
                    }
                },
                grid: {
                    top: '3%',
                    left: '6%',
                    right: '3%',
                    bottom: '12%'
                },
                xAxis: {
                    type: 'category',
                    data: dateLabels,
                    splitArea: { show: true, areaStyle: { color: ['#1a202c', '#2d3748'] } },
                    axisLabel: {
                        color: '#a0aec0',
                        rotate: 45,
                        fontSize: 11
                    },
                    splitLine: { lineStyle: { color: '#4a5568' } }
                },
                yAxis: {
                    type: 'category',
                    data: hours,
                    splitArea: { show: true, areaStyle: { color: ['#1a202c', '#2d3748'] } },
                    axisLabel: { color: '#a0aec0', fontSize: 11 },
                    splitLine: { lineStyle: { color: '#4a5568' } }
                },
                visualMap: {
                    min: 0,
                    max: Math.max(maxValue, 100),
                    calculable: true,
                    orient: 'horizontal',
                    left: 'center',
                    bottom: '1%',
                    inRange: {
                        color: ['#1a365d', '#2b6cb0', '#3182ce', '#63b3ed', '#bee3f8']
                    },
                    text: ['높음', '낮음'],
                    textStyle: { color: '#a0aec0' }
                },
                series: [{
                    name: '쿠폰 사용',
                    type: 'heatmap',
                    data: heatmapData,
                    label: {
                        show: true,
                        formatter: function(params) {
                            const value = params.data[2];
                            return value > 0 ? value : '';
                        },
                        fontSize: 10,
                        fontWeight: 'bold',
                        color: '#fff',
                        textBorderColor: '#000',
                        textBorderWidth: 2
                    },
                    itemStyle: {
                        borderColor: '#2d3748',
                        borderWidth: 1
                    },
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowColor: 'rgba(0, 0, 0, 0.3)'
                        }
                    }
                }]
            };

            heatmapChart.setOption(option);

            return universities;
        }

        // 실시간 통계 렌더링
        function renderRealtimeStats(current) {
            if (!current || !current.snapshots || current.snapshots.length === 0) {
                return `
                    <div class="realtime-section">
                        <h3>실시간 현황 (5분 갱신)</h3>
                        <p>아직 수집된 데이터가 없습니다.</p>
                    </div>
                `;
            }

            const latest = current.snapshots[current.snapshots.length - 1];

            // type에 따라 데이터 합산
            const types = selectedType === 'all' ? ['group', 'personal'] : [selectedType];
            let totalUsed = 0, totalCoupons = 0;
            const allUnis = new Set();

            for (const t of types) {
                const typeData = latest[t] || {};
                totalUsed += Object.values(typeData).reduce((sum, v) => sum + (v.used || 0), 0);
                totalCoupons += Object.values(typeData).reduce((sum, v) => sum + (v.total || 0), 0);
                Object.keys(typeData).forEach(u => allUnis.add(u));
            }

            const usageRate = totalCoupons > 0 ? (totalUsed / totalCoupons * 100).toFixed(1) : 0;
            const uniCount = allUnis.size;

            const lastUpdate = new Date(latest.time).toLocaleString('ko-KR');
            const typeLabel = selectedType === 'all' ? '전체' : (selectedType === 'group' ? '단체 쿠폰' : '개인 쿠폰');

            return `
                <div class="realtime-section">
                    <h3>실시간 현황 (5분 갱신) - ${typeLabel}</h3>
                    <div class="realtime-stats">
                        <div class="realtime-stat">
                            <div class="value">${totalUsed.toLocaleString()}</div>
                            <div class="label">총 사용</div>
                        </div>
                        <div class="realtime-stat">
                            <div class="value">${totalCoupons.toLocaleString()}</div>
                            <div class="label">총 쿠폰</div>
                        </div>
                        <div class="realtime-stat">
                            <div class="value">${usageRate}%</div>
                            <div class="label">사용률</div>
                        </div>
                        <div class="realtime-stat">
                            <div class="value">${current.snapshots.length}</div>
                            <div class="label">스냅샷 수</div>
                        </div>
                    </div>
                    <p style="margin-top:10px;font-size:0.85rem;opacity:0.8;">마지막 업데이트: ${lastUpdate}</p>
                </div>
            `;
        }

        // 메인 렌더링
        async function render() {
            currentData = await loadCurrentData();

            // 먼저 기본 HTML 렌더링
            const html = `
                ${renderRealtimeStats(currentData)}

                <div class="chart-container">
                    <div class="controls">
                        <div class="type-toggle">
                            <button class="type-btn ${selectedType === 'all' ? 'active' : ''}" onclick="switchType('all')">전체</button>
                            <button class="type-btn ${selectedType === 'group' ? 'active' : ''}" onclick="switchType('group')">단체 쿠폰</button>
                            <button class="type-btn ${selectedType === 'personal' ? 'active' : ''}" onclick="switchType('personal')">개인 쿠폰</button>
                        </div>
                        <label>
                            대학교:
                            <select id="uniSelect" onchange="changeUniversity(this.value)">
                                <option value="">로딩 중...</option>
                            </select>
                        </label>
                    </div>
                    <h2>시간별 사용 현황 히트맵</h2>
                    <div id="heatmap"></div>
                </div>

            `;

            document.getElementById('content').innerHTML = html;

            // 히트맵 렌더링 및 대학교 목록 가져오기
            const universities = await renderHeatmap();

            // 대학교 드롭다운 업데이트 (전체 옵션 추가)
            if (universities && universities.length > 0) {
                const uniSelect = document.getElementById('uniSelect');
                const allOption = `<option value="__ALL__" ${selectedUniversity === '__ALL__' ? 'selected' : ''}>전체</option>`;
                const uniOptions = universities.map(u =>
                    `<option value="${u}" ${u === selectedUniversity ? 'selected' : ''}>${u}</option>`
                ).join('');
                uniSelect.innerHTML = allOption + uniOptions;
            }

        }

        // 쿠폰 유형 전환
        function switchType(type) {
            selectedType = type;
            selectedUniversity = '__ALL__'; // 타입 변경 시 전체로 초기화
            render();
        }

        // 대학교 변경
        async function changeUniversity(uni) {
            selectedUniversity = uni;
            await renderHeatmap();
        }

        // D-Day 계산
        function updateDaysLeft() {
            const deadline = new Date('2026-01-10T23:59:59');
            const now = new Date();
            const diff = deadline - now;
            const daysLeft = Math.ceil(diff / (1000 * 60 * 60 * 24));
            const el = document.getElementById('daysLeft');
            if (el) {
                if (daysLeft > 0) el.textContent = `D-${daysLeft}`;
                else if (daysLeft === 0) el.textContent = 'D-Day';
                else el.textContent = '마감됨';
            }
        }

        // 윈도우 리사이즈 대응
        window.addEventListener('resize', () => {
            if (heatmapChart) heatmapChart.resize();
        });

        // 초기화
        updateDaysLeft();
        render();
    </script>
</body>
</html>
